@{
    ViewData["Title"] = "CreateReservationModal";
    Layout = "~/Views/UILayout/Index.cshtml";

    var locations = ViewBag.Locations as List<GetLocationWithCityViewModel>;
    var mileagePackages = ViewBag.MileagePackages as List<ResultMileagePackageViewModel>;
    var securityPackages = ViewBag.SecurityPackages as List<GetSecurityPackagesWithPackageOptionsViewModel>;
    var features = ViewBag.Features as List<ResultFeatureViewModel>;
    var pricings = ViewBag.Pricings as List<ResultPricingViewModel>;
}

<style>
    input,
    select,
    textarea {
        cursor: pointer !important;
    }

    .model-card {
        position: relative;
        border: 2px solid #ddd;
        border-radius: 12px;
        padding: 0; /* resim üstte tam otursun diye padding kaldırıldı */
        cursor: pointer;
        transition: transform .2s ease, border-color .2s;
        background: white;
        height: 360px; /* kartı büyütüyoruz */
        overflow: hidden;
    }

    .model-hover {
        transform: scale(1.04);
        border-color: #0d6efd;
    }

    .selected-model {
        border-color: #28a745 !important;
        box-shadow: 0 0 20px rgba(40,167,69,.4);
    }

    /* --- RESİM ALANI --- */
    .model-image-container {
        width: 100%;
        height: 180px; /* yükseklik artırıldı */
        overflow: hidden;
    }

        .model-image-container img {
            width: 100%;
            height: 100%;
            object-fit: cover; /* resmi kenarlara tam doldurur */
            object-position: center;
        }

    /* --- MODEL BİLGİ ALANI --- */
    .model-info {
        padding: 6px 5px;
    }

    /* --- FİYAT ALANI --- */
    .price-area {
        position: absolute;
        bottom: 12px;
        right: 12px;
        font-size: 1.3rem;
        font-weight: bold;
        color: #28a745; /* yeşil */
    }

    /* --- DETAY BUTONU --- */
    .details-area {
        position: absolute;
        bottom: 12px;
        left: 12px;
    }

    .mileage-card {
        position: relative;
        border: 2px solid #ddd;
        border-radius: 16px;
        padding: 24px; /* ⬅️ İç boşluk arttı */
        cursor: pointer;
        transition: transform .2s ease, border-color .2s, box-shadow .2s;
        background: white;
        min-height: 220px; /* ⬅️ Kartlar belirgin şekilde büyür */
        height: 100%;
        display: flex;
        flex-direction: column;
        justify-content: space-between;
    }

        .mileage-card:hover {
            transform: scale(1.04); /* ⬅️ 1.05 yerine daha yumuşak */
            box-shadow: 0 10px 25px rgba(0,0,0,.12);
        }

    .security-card {
        position: relative;
        border: 2px solid #ddd;
        border-radius: 12px;
        padding: 16px;
        cursor: pointer;
        transition: transform .2s ease, border-color .2s;
        background: white;
        height: 100%;
    }

        .security-card:hover {
            transform: scale(1.05);
        }

    .selected-security {
        border-color: #28a745 !important;
        box-shadow: 0 0 10px rgba(40,167,69,.4);
    }
</style>

<div class="container my-4">
    <h1 class="mb-4 text-center fw-bold">Rezervasyon Oluştur</h1>

    <!-- Adım 1 -->
    <div id="step-1" class="reservation-step">

        <div class="card shadow-lg border-0 rounded-4">
            <div class="card-header bg-primary text-white py-3 rounded-top-4">
                <h4 class="mb-0 fw-semibold">1. Adım: Lokasyon ve Tarih/Saat Bilgileri</h4>
            </div>

            <div class="card-body p-4">
                <form id="form-step-1">

                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label for="pickupLocation" class="form-label fw-semibold">Alış Lokasyonu</label>
                            <select id="pickupLocation" class="form-select rounded-2 px-3 py-2" style="height: 46px;">
                                <option value="">Seçiniz</option>
                            </select>
                        </div>

                        <div class="col-md-6">
                            <label for="dropoffLocation" class="form-label fw-semibold">Teslim Lokasyonu</label>
                            <select id="dropoffLocation" class="form-select rounded-2 px-3 py-2" style="height: 46px;">
                                <option value="">Seçiniz</option>
                            </select>
                        </div>
                    </div>

                    <div class="row mb-3">

                        <div class="col-md-3">
                            <label for="pickupDate" class="form-label fw-semibold">Alış Tarihi</label>
                            <input type="date" id="pickupDate" class="form-control p-3 rounded-3">
                        </div>

                        <div class="col-md-3">
                            <label for="pickupTime" class="form-label fw-semibold">Alış Saati</label>
                            <input type="time" id="pickupTime" class="form-control p-3 rounded-3">
                        </div>

                        <div class="col-md-3">
                            <label for="dropoffDate" class="form-label fw-semibold">Teslim Tarihi</label>
                            <input type="date" id="dropoffDate" class="form-control p-3 rounded-3">
                        </div>

                        <div class="col-md-3">
                            <label for="dropoffTime" class="form-label fw-semibold">Teslim Saati</label>
                            <input type="time" id="dropoffTime" class="form-control p-3 rounded-3">
                        </div>

                    </div>

                    <div class="d-flex justify-content-end mt-3">
                        <button type="button" class="btn btn-primary btn-lg px-4" id="nextStep1">
                            Sonraki Adım
                        </button>
                    </div>

                </form>
            </div>
        </div>
    </div>

    <!-- Adım 2 -->
    <div id="step-2" class="reservation-step d-none">
        <div class="card shadow-lg border-0 rounded-4">
            <div class="card-header bg-primary text-white py-3 rounded-top-4">
                <h4 class="mb-0 fw-semibold">2. Adım: Araç Modeli Seçimi</h4>
            </div>

            <div class="card-body p-4">
                <div id="modelsContainer" class="row gy-3">
                    <!-- Dinamik olarak dolacak -->
                </div>

                <div class="d-flex justify-content-between mt-4">
                    <button type="button" class="btn btn-secondary px-4" id="prevStep2">Önceki Adım</button>
                    <button type="button" class="btn btn-primary px-4" id="nextStep2">Sonraki Adım</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Adım 3 -->
    <div id="step-3" class="reservation-step d-none">
        <div class="card shadow-lg border-0 rounded-4">
            <div class="card-header bg-primary text-white py-3 rounded-top-4">
                <h4 class="mb-0 fw-semibold">3. Adım: Kilometre Paketi Seçimi</h4>
            </div>

            <div class="card-body p-4">
                <div id="mileageContainer" class="row gy-3">
                    <!-- Dinamik içerik -->
                </div>

                <div class="d-flex justify-content-between mt-4">
                    <button type="button" class="btn btn-secondary px-4" id="prevStep3">Önceki Adım</button>
                    <button type="button" class="btn btn-primary px-4" id="nextStep3">Sonraki Adım</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Adım 4 -->
    <div id="step-4" class="reservation-step d-none">
        <div class="card shadow-lg border-0 rounded-4">
            <div class="card-header bg-primary text-white py-3 rounded-top-4">
                <h4 class="mb-0 fw-semibold">4. Adım: Güvenlik Paketi Seçimi</h4>
            </div>

            <div class="card-body p-4">
                <div id="securityContainer" class="row gy-3">
                    <!-- Dinamik içerik -->
                </div>

                <div class="d-flex justify-content-between mt-4">
                    <button type="button" class="btn btn-secondary px-4" id="prevStep4">Önceki Adım</button>
                    <button type="button" class="btn btn-success px-4" id="showSummary">Rezervasyon Özetini Gör</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Rezervasyon Özeti -->
    <div id="step-5" class="reservation-step d-none">
        <div class="card shadow-lg border-0 rounded-4">
            <div class="card-header bg-success text-white py-3 rounded-top-4">
                <h4 class="mb-0 fw-semibold">Rezervasyon Özeti</h4>
            </div>

            <div class="card-body p-4">

                <!-- Lokasyon & Tarih -->
                <div class="mb-4">
                    <h6 class="fw-bold">Rezervasyon Bilgileri</h6>
                    <p class="mb-1">
                        <strong>Alış:</strong> <span id="summaryPickupLocation"></span>
                    </p>
                    <p class="mb-1">
                        <strong>Teslim:</strong> <span id="summaryDropoffLocation"></span>
                    </p>
                    <p class="mb-0">
                        <strong>Tarih:</strong>
                        <span id="summaryDateTime"></span>
                    </p>
                </div>

                <hr />

                <!-- Seçilenler -->
                <div class="row gy-4">

                    <div class="col-md-4">
                        <h6 class="fw-bold mb-2">Araç</h6>
                        <div id="summaryModel"></div>
                    </div>

                    <div class="col-md-4">
                        <h6 class="fw-bold mb-2">Kilometre Paketi</h6>
                        <div id="summaryMileage"></div>
                    </div>

                    <div class="col-md-4">
                        <h6 class="fw-bold mb-2">Güvenlik Paketi</h6>
                        <div id="summarySecurity"></div>
                    </div>

                </div>

                <hr />

                <!-- Fiyatlar -->
                <div class="mt-4">
                    <div class="d-flex justify-content-between">
                        <span>Araç Fiyatı</span>
                        <strong id="summaryModelPrice"></strong>
                    </div>
                    <div class="d-flex justify-content-between">
                        <span>Kilometre Paketi</span>
                        <strong id="summaryMileagePrice"></strong>
                    </div>
                    <div class="d-flex justify-content-between">
                        <span>Güvenlik Paketi</span>
                        <strong id="summarySecurityPrice"></strong>
                    </div>

                    <hr />

                    <div class="d-flex justify-content-between fs-5">
                        <strong>Toplam Fiyat</strong>
                        <strong class="text-success" id="summaryTotalPrice"></strong>
                    </div>
                </div>

                <div class="d-flex justify-content-between mt-4">
                    <button type="button" class="btn btn-secondary px-4" id="prevStep5">
                        Önceki Adım
                    </button>
                    <button type="button" class="btn btn-success px-4" id="confirmReservation">
                        Rezervasyonu Onayla
                    </button>
                </div>

            </div>
        </div>
    </div>

</div>

<div class="modal fade" id="modelDetailModal" tabindex="-1">
    <div class="modal-dialog modal-lg modal-dialog-centered modal-dialog-scrollable">
        <div class="modal-content rounded-4">

            <div class="modal-header">
                <h5 class="modal-title" id="modelDetailTitle">Model Detayı</h5>

                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>

            <div class="modal-body">

                <img id="modelDetailImage"
                     class="img-fluid rounded mb-3 w-100"
                     style="max-height:300px; object-fit:cover;" />

                <p id="modelDetailDescription" class="text-muted"></p>

                <div class="d-flex gap-4 mb-3">
                    <span class="mr-2"><i class="bi bi-person-fill"></i> <strong id="detailSeat"></strong></span>
                    <span><i class="bi bi-luggage-fill"></i> <strong id="detailLuggage"></strong></span>
                    <span class="ml-3"><strong>Sınıf:</strong> <span id="detailClass"></span></span>
                </div>

                <hr />

                <h6 class="fw-bold mb-2">Araç Özellikleri</h6>
                <div id="modelFeaturesContainer" class="row"></div>

            </div>

            <div class="modal-footer">
                <button class="btn btn-secondary" data-dismiss="modal">Kapat</button>
            </div>

        </div>
    </div>
</div>

<script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

<script>
    $(document).ready(function () {

        let selectedMileagePackageId = null;
        let selectedSecurityPackageId = null;

        function populateLocations() {
            // locations (Razor tarafında zaten atadığın 'locations' değişkenini JS'e serialize ediyoruz)
            const locations = @Html.Raw(Newtonsoft.Json.JsonConvert.SerializeObject(locations));

            // Traveler.ViewModel.Enums.CityEnum enumunu JS'e aktar
            var cityEnum = @Html.Raw(
                                Newtonsoft.Json.JsonConvert.SerializeObject(
                                        Enum.GetValues(typeof(Traveler.ViewModel.Enums.CityEnum))
                                                .Cast<Traveler.ViewModel.Enums.CityEnum>()
                                                .ToDictionary(e => (int)e, e => e.ToString())
                                )
                        );

            const $pickup = $("#pickupLocation");
            const $dropoff = $("#dropoffLocation");

            // Başlangıç seçeneği: seçilemez ve seçili
            const defaultOption = `<option value="" selected disabled>Lokasyon Seçiniz</option>`;
            $pickup.html(defaultOption);
            $dropoff.html(defaultOption);

            // Lokasyonları ekleme
            $.each(locations, function (i, loc) {
                const cityKey = loc.City && (loc.City.CityName || loc.City.cityName || loc.City.CityId) ? (loc.City.CityName || loc.City.cityName) : null;
                const cityText = cityKey && cityEnum[cityKey] ? cityEnum[cityKey] : "Bilinmeyen Şehir";
                const optionText = `${cityText} - ${loc.LocationName}`;
                const optionHtml = `<option value="${loc.LocationId}">${optionText}</option>`;

                $pickup.append(optionHtml);
                $dropoff.append(optionHtml);
            });
        }

        function validateStep1() {

            const pickupId = $("#pickupLocation").val();
            const dropoffId = $("#dropoffLocation").val();
            const pickupDate = $("#pickupDate").val();
            const dropoffDate = $("#dropoffDate").val();
            const pickupTime = $("#pickupTime").val();
            const dropoffTime = $("#dropoffTime").val();

            // 1. Alanlar boş mu kontrol
            if (!pickupId || !dropoffId || !pickupDate || !dropoffDate || !pickupTime || !dropoffTime) {
                Swal.fire({
                    icon: 'warning',
                    title: 'Eksik Bilgi',
                    text: 'Lütfen tüm alanları doldurun.'
                });
                return false;
            }

            // 2. Tarih ve saatleri birleştir
            const pickupDateTime = new Date(`${pickupDate}T${pickupTime}`);
            const dropoffDateTime = new Date(`${dropoffDate}T${dropoffTime}`);

            // 3. Tarih validasyonu
            if (dropoffDateTime <= pickupDateTime) {
                Swal.fire({
                    icon: 'error',
                    title: 'Geçersiz Tarih',
                    text: 'Teslim tarihi ve saati, alış tarihinden sonra olmalıdır.'
                });
                return false;
            }

            // 4. Hata yok, Swal -> kapanınca step2'ye geçiş
            Swal.fire({
                icon: 'info',
                title: 'Lütfen Bekleyin',
                text: 'Seçtiğiniz lokasyondaki modeller aranıyor...',
                timer: 3000,
                timerProgressBar: true,
                showConfirmButton: false,
                didOpen: () => {
                    Swal.showLoading();
                }
            }).then(() => {
                // Swal kapanınca 2. adıma geç
                goToStep2();
            });

            return true;
        }

        function loadAvailableModels() {

            let pickupLocationId = $("#pickupLocation").val();

            if (!pickupLocationId) {
                Swal.fire("Hata", "Lütfen geçerli bir alış lokasyonu seçiniz.", "error");
                return;
            }

            // --- UI geçişi (Adım 1 → Adım 2) ---
            $("#step-1").addClass("d-none");
            $("#step-2").removeClass("d-none");

            // Modeller yükleniyor mesajı
            $("#modelsContainer").html(`
                <div class="col-12 text-center my-4">
                    <div class="spinner-border text-primary" role="status"></div>
                    <p class="mt-2 fw-semibold">Modeller yükleniyor...</p>
                </div>
            `);

            $.ajax({
                url: "/Reservation/GetAvailableModels",
                type: "GET",
                data: { locationId: pickupLocationId },
                success: function (models) {
                    window.availableModels = models;
                    renderModels(models);

                    if (!models || models.length === 0) {
                        $("#modelsContainer").html(`
                            <div class="col-12 text-center text-danger fw-bold my-4">
                                Bu lokasyonda uygun araç bulunamadı.
                            </div>
                        `);
                        return;
                    }

                    renderModels(models);
                },
                error: function () {
                    Swal.fire("Hata", "Modeller yüklenirken bir hata oluştu.", "error");
                }
            });
        }

        function renderModels(models) {

            $("#modelsContainer").empty();

            let pricings = @Html.Raw(Json.Serialize(pricings));

            let totalMinutes = getTotalMinutes(
                $("#pickupDate").val(),
                $("#pickupTime").val(),
                $("#dropoffDate").val(),
                $("#dropoffTime").val()
            );

            let grouped = {};

            models.forEach(m => {
                let className = m.carClass.className;

                if (!grouped[className]) grouped[className] = [];

                grouped[className].push(m);
            });

            Object.keys(grouped).forEach(className => {

                // Grup başlığı
                $("#modelsContainer").append(`
                    <div class="col-12">
                        <h4 class="fw-bold mt-4 mb-3">${className}</h4>
                    </div>
                `);

                grouped[className].forEach(model => {

                    let price = calculateModelPrice(model, totalMinutes, pricings);

                    let cardHtml = `
                        <div class="col-12 col-sm-6 col-md-4 col-lg-3 mb-4">
                            <div class="model-card" data-model-id="${model.modelId}">

                                <div class="model-image-container">
                                    <img src="${model.coverImageUrl}" />
                                </div>

                                <div class="model-info text-center mt-2">
                                    <h5 class="fw-bold">${model.brand.name}</h5>
                                    <p class="m-0">${model.modelName}</p>

                                    <div class="d-flex justify-content-center mt-2 gap-3">
                                        <div class="d-flex align-items-center gap-1 mr-2">
                                            <i class="bi bi-person-fill"></i> ${model.seat}
                                        </div>
                                        <div class="d-flex align-items-center gap-1">
                                            <i class="bi bi-luggage-fill mx-1"></i> ${model.luggage}
                                        </div>
                                    </div>
                                </div>

                                    <div class="price-area">
                                        <span class="fw-bold">${price.toLocaleString("tr-TR")} ₺</span>
                                    </div>

                                <div class="details-area">
                                    <button
                                        type="button"
                                        class="btn btn-outline-secondary btn-sm"
                                        onclick="modelDetailModal(${model.modelId})">
                                        ...
                                    </button>
                                </div>

                            </div>
                        </div>
                    `;

                    $("#modelsContainer").append(cardHtml);
                });
            });

            attachModelEvents();
        }

        function attachModelEvents() {

            // Hover efekti
            $(".model-card").hover(
                function () { $(this).addClass("model-hover"); },
                function () { $(this).removeClass("model-hover"); }
            );

            // Model seçimi
            $(".model-card").on("click", function () {

                $(".model-card").removeClass("selected-model");

                $(this).addClass("selected-model");

                let selectedId = $(this).data("model-id");

                $("#selectedModelId").val(selectedId); // → Eğer 3. adım için lazım olacaksa
                window.selectedModel = window.availableModels.find(
                    m => m.ModelId === selectedId || m.modelId === selectedId
                );
            });
        }

        function goToStep2() {
            $("#step-1").addClass("d-none");
            $("#step-2").removeClass("d-none");

            loadAvailableModels();
            $("html, body").animate({ scrollTop: 0 }, 300);
        }

        function backToStep1() {
            $("#step-2").addClass("d-none");
            $("#step-1").removeClass("d-none");

            $("html, body").animate({ scrollTop: 0 }, 300);
        }

        function calculateModelPrice(model, totalMinutes, pricings) {

            // Enum karşılıkları dakika cinsinden
            const pricingDurations = {
                1: 1,                 // Dakika
                2: 60,                // Saat
                3: 1440,              // Gün
                4: 10080,             // Hafta (7 gün)
                5: 43200,             // Ay (30 gün)
                6: 518400             // Yıl (360 gün)
            };

            const modelPricings = model.modelPricings;

            if (!modelPricings || modelPricings.length === 0) {
                return 0;
            }

            // Pricings listesini süreye dönüştür
            let pricingList = pricings.map(p => ({
                pricingId: p.PricingId,
                duration: pricingDurations[p.PricingType] * p.Quantity,  // dakika
                pricingType: p.PricingType
            }));

            // En büyük süreden en küçüğe sırala
            pricingList.sort((a, b) => b.duration - a.duration);

            let remaining = totalMinutes;
            let totalPrice = 0;

            for (let p of pricingList) {

                // Modelin bu pricing’e ait fiyatı
                let modelPricing = modelPricings.find(mp => mp.pricingId === p.pricingId);
                if (!modelPricing) continue;

                // Bu süre rezervasyon süresine uyduğu sürece eklemeye devam et
                while (remaining >= p.duration) {
                    totalPrice += parseFloat(modelPricing.amount);
                    remaining -= p.duration;
                }
            }

            return totalPrice;
        }

        function getTotalMinutes(pickupDate, pickupTime, dropoffDate, dropoffTime) {
            const start = new Date(`${pickupDate}T${pickupTime}`);
            const end = new Date(`${dropoffDate}T${dropoffTime}`);

            const diffMs = end - start;
            return Math.floor(diffMs / 60000); // milisaniye → dakika
        }

        function renderMileagePackages() {

            $("#mileageContainer").empty();

            let mileagePackages = @Html.Raw(Json.Serialize(mileagePackages));

            mileagePackages.forEach(pkg => {

                let cardHtml = `
                    <div class="col-12 col-sm-6 col-md-4 col-lg-3 mb-3">
                        <div class="mileage-card"
                             data-package-id="${pkg.MileagePackageId}">

                            <div class="text-center">
                                <h5 class="fw-bold">${pkg.PackageName}</h5>

                                ${pkg.Description ? `<p class="text-muted small mb-2">${pkg.Description}</p>` : ""}

                                <div class="fw-semibold mb-2">
                                    ${pkg.PackageLimit === 2147483647
                                        ? "Sınırsız"
                                        : `${pkg.PackageLimit.toLocaleString("tr-TR")} KM`
                                    }
                                </div>
                            </div>

                            <div class="price-area text-success fw-bold">
                                ${pkg.Amount.toLocaleString("tr-TR")} ₺
                            </div>

                        </div>
                    </div>
                `;

                $("#mileageContainer").append(cardHtml);
            });

            attachMileageEvents();
        }

        function attachMileageEvents() {

            $(".mileage-card")
                .hover(
                    function () {
                        $(this).addClass("model-hover");
                    },
                    function () {
                        $(this).removeClass("model-hover");
                    }
                )
                .click(function () {

                    $(".mileage-card").removeClass("selected-model");

                    $(this).addClass("selected-model");

                    selectedMileagePackageId = $(this).data("package-id");

                    let mileagePackages = @Html.Raw(Json.Serialize(mileagePackages));

                    window.selectedMileagePackage = mileagePackages.find(
                        p => p.MileagePackageId === selectedMileagePackageId
                    );
                });
        }

        function renderSecurityPackages() {

            $("#securityContainer").empty();

            let securityPackages = @Html.Raw(Json.Serialize(securityPackages));

            securityPackages.forEach(pkg => {

                let optionsHtml = "";

                pkg.SecurityPackageOptions.forEach(opt => {
                    optionsHtml += `
                        <div class="col-12 mb-2">
                            <span class="d-flex align-items-center">
                                <i class="bi bi-check-circle-fill text-success"></i>
                                <span>${opt}</span>
                            </span>
                        </div>
                    `;
                });

                let cardHtml = `
                    <div class="col-12 col-sm-6 col-md-4 col-lg-3">
                        <div class="security-card"
                             data-security-package-id="${pkg.SecurityPackageId}">

                            <div class="text-center mb-3">
                                <h5 class="fw-bold">${pkg.PackageName}</h5>
                            </div>

                            <div class="price-area text-success fw-bold">
                                ${pkg.Amount.toLocaleString("tr-TR")} ₺
                            </div>

                            <hr />

                            <div class="row">
                                ${optionsHtml}
                            </div>

                        </div>
                    </div>
                `;

                $("#securityContainer").append(cardHtml);
            });

            attachSecurityEvents();
        }

        function attachSecurityEvents() {

            $(".security-card").off("click").on("click", function () {

                // Diğer tüm seçimleri kaldır
                $(".security-card").removeClass("selected-security");

                // Tıklananı seç
                $(this).addClass("selected-security");

                // Seçilen paketi sakla
                selectedSecurityPackageId = $(this).data("security-package-id");

                let securityPackages = @Html.Raw(Json.Serialize(securityPackages));

                window.selectedSecurityPackage = securityPackages.find(
                    p => p.SecurityPackageId === selectedSecurityPackageId
                );

            });
        }

        function renderReservationSummary() {

            // Step geçişleri
            $(".reservation-step").addClass("d-none");
            $("#step-5").removeClass("d-none");

            // Lokasyon & Tarih
            $("#summaryPickupLocation").text(
                $("#pickupLocation option:selected").text()
            );

            $("#summaryDropoffLocation").text(
                $("#dropoffLocation option:selected").text()
            );

            $("#summaryDateTime").text(
                `${$("#pickupDate").val()} ${$("#pickupTime").val()} →
                 ${$("#dropoffDate").val()} ${$("#dropoffTime").val()}`
            );

            // Seçilen model
            let model = window.selectedModel;
            let mileage = window.selectedMileagePackage;
            let security = window.selectedSecurityPackage;

            let totalMinutes = getTotalMinutes(
                $("#pickupDate").val(),
                $("#pickupTime").val(),
                $("#dropoffDate").val(),
                $("#dropoffTime").val()
            );

            let pricings = @Html.Raw(Json.Serialize(pricings));

            let modelPrice = calculateModelPrice(model, totalMinutes, pricings);

            // Model kartı
            $("#summaryModel").html(`
                <div class="model-card">
                    <div class="model-image-container">
                        <img src="${model.coverImageUrl}" />
                    </div>
                    <div class="text-center mt-2">
                        <strong>${model.brand.name} ${model.modelName}</strong>
                    </div>
                </div>
            `);

            // Mileage kartı
            $("#summaryMileage").html(`
                <div class="mileage-card text-center">
                    <strong>${mileage.PackageName}</strong><br/>
                    ${mileage.Description}
                    <div class="fw-semibold mb-2">
                        ${mileage.PackageLimit === 2147483647 ? "Sınırsız" : mileage.PackageLimit + " KM"}
                    </div>
                </div>
            `);

            // Security kartı
            $("#summarySecurity").html(`
                <div class="security-card text-center">
                    <strong>${security.PackageName}</strong>
                </div>
            `);

            // Fiyatlar
            $("#summaryModelPrice").text(modelPrice.toLocaleString("tr-TR") + " ₺");
            $("#summaryMileagePrice").text(mileage.Amount.toLocaleString("tr-TR") + " ₺");
            $("#summarySecurityPrice").text(security.Amount.toLocaleString("tr-TR") + " ₺");

            window.totalReservationPrice =
                Number(modelPrice) +
                Number(mileage.Amount) +
                Number(security.Amount);

            $("#summaryTotalPrice").text(window.totalReservationPrice.toLocaleString("tr-TR") + " ₺");
        }

        function submitReservation() {

            // 🔒 Zorunlu seçim kontrolleri
            if (!window.selectedModel) {
                Swal.fire("Uyarı", "Lütfen bir araç modeli seçin", "warning");
                return;
            }

            if (!window.selectedMileagePackage) {
                Swal.fire("Uyarı", "Lütfen bir kilometre paketi seçin", "warning");
                return;
            }

            if (!window.selectedSecurityPackage) {
                Swal.fire("Uyarı", "Lütfen bir güvenlik paketi seçin", "warning");
                return;
            }

            // 📦 ViewModel
            let reservationData = {
                PickUpLocationId: parseInt($("#pickupLocation").val()),
                DropOffLocationId: parseInt($("#dropoffLocation").val()),

                PickUpDate: $("#pickupDate").val(),       // yyyy-MM-dd
                DropOffDate: $("#dropoffDate").val(),

                PickUpTime: $("#pickupTime").val(),       // HH:mm
                DropOffTime: $("#dropoffTime").val(),

                MileagePackageId: window.selectedMileagePackage.MileagePackageId,
                SecurityPackageId: window.selectedSecurityPackage.SecurityPackageId,

                CreatedTime: new Date().toISOString(),
                UpdatedTime: new Date().toISOString(),

                TotalAmount: window.totalReservationPrice // özet ekranında hesapladığımız toplam
            };

            let data = {
                modelId: window.selectedModel.modelId,   // 👈 AYRI GÖNDERİLİYOR
                reservation: reservationData
            };

            $.ajax({
                url: "/Reservation/CreateReservation",
                type: "POST",
                contentType: "application/json",
                data: JSON.stringify(data),
                success: function (response) {

                    Swal.fire({
                        icon: "success",
                        title: "Rezervasyon Oluşturuldu",
                        text: "Rezervasyonunuz başarıyla oluşturuldu.",
                        confirmButtonText: "Tamam"
                    }).then(() => {
                        window.location.href = "/Home/Index";
                    });
                },
                error: function (xhr) {

                    Swal.fire(
                        "Hata",
                        xhr.responseText || "Rezervasyon oluşturulurken hata oluştu",
                        "error"
                    );
                }
            });
        }

        window.modelDetailModal = function (modelId) {

            let features = @Html.Raw(Json.Serialize(features));

            // Daha önce çektiğimiz modeller arasından buluyoruz
            let model = window.availableModels.find(m => m.modelId === modelId);
            if (!model) return;

            $("#modelDetailTitle").text(`${model.brand.name} ${model.modelName}`);
            $("#modelDetailImage").attr("src", model.bigImageUrl || model.coverImageUrl);
            $("#modelDetailDescription").text(model.modelDescription);

            $("#detailSeat").text(model.seat);
            $("#detailLuggage").text(model.luggage);
            $("#detailClass").text(model.carClass.className);

            // Feature alanını temizle
            $("#modelFeaturesContainer").empty();

            // Tüm feature'ları dolaş
            features.forEach(f => {

                let modelFeature = model.modelFeatures.find(mf => mf.featureId === f.FeatureId);
                let available = modelFeature && modelFeature.available;

                if(available){
                    $("#modelFeaturesContainer").append(`
                    <div class="col-md-6 mb-2">
                        <span class="d-flex align-items-center gap-2">
                            <i class="bi bi-check-circle-fill text-success mr-1"></i>
                            <span>${f.FeatureName}</span>
                        </span>
                    </div>
                `);
                }
            });

            // Modalı aç
            let modal = new bootstrap.Modal(document.getElementById("modelDetailModal"));
            modal.show();
        }

        // --- Sonraki Adım Butonuna Tıklama ---
        $("#nextStep1").on("click", function (e) {
            e.preventDefault();
            validateStep1();
        });

        $("#nextStep2").on("click", function (e) {
            e.preventDefault();

            renderMileagePackages();

            // TÜM adımları gizle
            $(".reservation-step").addClass("d-none");

            // SADECE step-3'ü aç
            $("#step-3").removeClass("d-none");

            // Sayfayı yukarı al
            $("html, body").animate({ scrollTop: 0 }, 300);
        });

        $("#nextStep3").on("click", function (e) {
            e.preventDefault();

            renderSecurityPackages();

            // TÜM adımları gizle
            $(".reservation-step").addClass("d-none");

            // SADECE step-3'ü aç
            $("#step-4").removeClass("d-none");

            // Sayfayı yukarı al
            $("html, body").animate({ scrollTop: 0 }, 300);
        });

        $("#prevStep2").on("click", backToStep1);

        $("#prevStep3").on("click", function () {

            $(".reservation-step").addClass("d-none");
            $("#step-2").removeClass("d-none");

            $("html, body").animate({ scrollTop: 0 }, 300);
        });

        $("#prevStep4").on("click", function () {

            $(".reservation-step").addClass("d-none");
            $("#step-3").removeClass("d-none");

            $("html, body").animate({ scrollTop: 0 }, 300);
        });

        $("#showSummary").on("click", function () {
            renderReservationSummary();
        });

        $("#prevStep5").on("click", function () {
            $("#step-5").addClass("d-none");
            $("#step-4").removeClass("d-none");
        });

        $("#confirmReservation").on("click", function () {
            submitReservation();
        });

        // --- Sayfa açıldığında fonksiyonu çalıştır ---
        populateLocations();

    });
</script>