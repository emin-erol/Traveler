@using Newtonsoft.Json
@using Traveler.ViewModel.Enums
@model CreateReservationViewModel

@{
    ViewData["Title"] = "CreateReservationModal";
    Layout = "~/Views/UILayout/Index.cshtml";

    var locations = ViewBag.Locations as List<GetLocationWithCityAndAvailabilityViewModel>
                    ?? new List<GetLocationWithCityAndAvailabilityViewModel>();

    var cityEnumList = Enum.GetValues(typeof(CityEnum))
        .Cast<CityEnum>()
        .Select(e => new { Id = (int)e, Name = e.ToString() })
        .ToList();
}

<section class="ftco-section contact-section">

    <!-- 1. Adım: Lokasyon ve Tarih/Saat Seçimi -->
    <div id="step1" class="container">
        <div class="row d-flex mb-5 contact-info">
            <div class="col-md-12 block-9 mb-md-5">
                <h3 class="alert alert-success">Araç Rezervasyon Formu - 1. Adım</h3>

                <form id="reservationForm" method="post" asp-action="CreateReservation" asp-controller="Reservation" class="bg-light p-4">

                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="pickupLocation">Alış Lokasyonu</label>
                                <select id="pickupLocation" name="PickUpLocationId" class="form-control" required>
                                    <option value="" disabled selected>— Bir lokasyon seçin —</option>
                                    @foreach (var loc in locations)
                                    {
                                        <option value="@loc.LocationId">
                                            @loc.LocationName, @(((CityEnum)loc.City.CityName).ToString())
                                        </option>
                                    }
                                </select>
                                <div id="pickupDetails" class="mt-2 small text-muted" style="display:none;"></div>
                            </div>
                        </div>

                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="dropoffLocation">Teslim Lokasyonu</label>
                                <select id="dropoffLocation" name="DropOffLocationId" class="form-control" required>
                                    <option value="" disabled selected>— Bir lokasyon seçin —</option>
                                    @foreach (var loc in locations)
                                    {
                                        <option value="@loc.LocationId">
                                            @loc.LocationName, @(((CityEnum)loc.City.CityName).ToString())
                                        </option>
                                    }
                                </select>
                                <div id="dropoffDetails" class="mt-2 small text-muted" style="display:none;"></div>
                            </div>
                        </div>
                    </div>

                    <hr />

                    <div class="row">
                        <div class="col-md-3">
                            <div class="form-group">
                                <label for="pickupDate">Alış Tarihi</label>
                                <input type="date" id="pickupDate" name="PickUpDate" class="form-control" required />
                                <div id="pickupDateError" class="small text-danger mt-1" style="display:none;"></div>
                            </div>
                        </div>

                        <div class="col-md-3">
                            <div class="form-group">
                                <label for="pickupTime">Alış Saati</label>
                                <input type="time" id="pickupTime" name="PickUpTime" class="form-control" required />
                                <div id="pickupTimeError" class="small text-danger mt-1" style="display:none;"></div>
                            </div>
                        </div>

                        <div class="col-md-3">
                            <div class="form-group">
                                <label for="dropoffDate">Teslim Tarihi</label>
                                <input type="date" id="dropoffDate" name="DropOffDate" class="form-control" required />
                                <div id="dropoffDateError" class="small text-danger mt-1" style="display:none;"></div>
                            </div>
                        </div>

                        <div class="col-md-3">
                            <div class="form-group">
                                <label for="dropoffTime">Teslim Saati</label>
                                <input type="time" id="dropoffTime" name="DropOffTime" class="form-control" required />
                                <div id="dropoffTimeError" class="small text-danger mt-1" style="display:none;"></div>
                            </div>
                        </div>
                    </div>

                    <div class="mt-3">
                        <button type="button" id="nextStep" class="btn btn-primary">İleri</button>
                    </div>

                </form>
            </div>
        </div>
    </div>

    <!-- 2. Adım: Araç Seçimi -->
    <div id="step2" class="container" style="display:none;">
        <h3 class="alert alert-info">Araç Seçimi - 2. Adım</h3>

        <div id="carsList" class="row">
            <!-- Araç kartları buraya gelecek -->
        </div>

        <div class="mt-3">
            <button type="button" id="backToStep1" class="btn btn-secondary">Geri</button>
            <button type="button" id="nextStep2" class="btn btn-primary" disabled>İleri</button>
        </div>
    </div>

</section>

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

<script>
    var locations = @Html.Raw(Newtonsoft.Json.JsonConvert.SerializeObject(locations));
    var cityEnum = @Html.Raw(JsonConvert.SerializeObject(cityEnumList));

    const dayNames = { 1: "Pazartesi", 2: "Salı", 3: "Çarşamba", 4: "Perşembe", 5: "Cuma", 6: "Cumartesi", 7: "Pazar" };

    function formatTimeRange(start, end) {
        if (!start || !end) return "Belirtilmemiş";
        return (start.length >= 5 ? start.substring(0,5) : start) + " - " + (end.length >= 5 ? end.substring(0,5) : end);
    }

    function availableDaysText(loc) {
        if (!loc || !loc.LocationAvailabilities) return "Bilgi yok";
        var days = loc.LocationAvailabilities
            .filter(x => x.IsAvailable)
            .map(x => dayNames[x.DayOfWeek])
            .filter(Boolean);
        return days.length ? days.join(", ") : "Herhangi bir gün açık değil";
    }

    function isLocationAvailableOnDate(loc, dateObj) {
        if (!loc) return false;
        var jsDay = dateObj.getDay();
        var modelDay = (jsDay === 0) ? 7 : jsDay;
        var entry = loc.LocationAvailabilities && loc.LocationAvailabilities.find(x => x.DayOfWeek === modelDay);
        return entry ? !!entry.IsAvailable : false;
    }

    function parseTimeToMinutes(hhmm) {
        if (!hhmm) return null;
        var parts = hhmm.split(":");
        if (parts.length < 2) return null;
        return parseInt(parts[0], 10) * 60 + parseInt(parts[1], 10);
    }

    function timeWithinRange(timeStr, startStr, endStr) {
        var t = parseTimeToMinutes(timeStr);
        var s = parseTimeToMinutes((startStr || "").substring(0,5));
        var e = parseTimeToMinutes((endStr || "").substring(0,5));
        if (t === null || s === null || e === null) return false;
        return t >= s && t <= e;
    }

    function formatLocationDetailsHtml(loc) {
        if (!loc) return "";
        var start = loc.StartTime ? loc.StartTime.substring(0,5) : "";
        var end = loc.EndTime ? loc.EndTime.substring(0,5) : "";
        var days = availableDaysText(loc);
        var desc = loc.Description ? `<div class="small text-muted mb-1">${loc.Description}</div>` : "";
        return `
            ${desc}
            <div class="p-2 border rounded bg-light">
                <div><strong>Çalışma Saatleri:</strong> ${start ? start : "-"} - ${end ? end : "-"}</div>
                <div><strong>Aktif Günler:</strong> ${days}</div>
                <div><strong>Şehir:</strong> ${loc.City ? ( (typeof loc.City.CityName === "number") ? dayOrCityName(loc.City.CityName) : loc.City.CityName) : "-"}</div>
            </div>
        `;
    }

    function dayOrCityName(cityId) {
        var city = cityEnum.find(c => c.Id === cityId);
        return city ? city.Name : "-";
    }

    function getNextAvailableDate(loc, fromDate) {
        if (!loc) return null;
        var start = new Date(fromDate.getFullYear(), fromDate.getMonth(), fromDate.getDate());
        for (var i = 0; i < 365; i++) {
            var d = new Date(start);
            d.setDate(start.getDate() + i);
            if (isLocationAvailableOnDate(loc, d)) {
                return d;
            }
        }
        return null;
    }

    var $pickupSelect = $('#pickupLocation');
    var $dropoffSelect = $('#dropoffLocation');
    var $pickupDetails = $('#pickupDetails');
    var $dropoffDetails = $('#dropoffDetails');

    var $pickupDate = $('#pickupDate');
    var $dropoffDate = $('#dropoffDate');
    var $pickupTime = $('#pickupTime');
    var $dropoffTime = $('#dropoffTime');

    var $pickupDateError = $('#pickupDateError');
    var $dropoffDateError = $('#dropoffDateError');
    var $pickupTimeError = $('#pickupTimeError');
    var $dropoffTimeError = $('#dropoffTimeError');

    function resetTimeConstraintsForPickup(loc) {
        if (!loc || !loc.StartTime || !loc.EndTime) {
            $pickupTime.attr('min', null).attr('max', null).val('');
            return;
        }
        var start = loc.StartTime.substring(0,5);
        var end = loc.EndTime.substring(0,5);
        $pickupTime.attr('min', start);
        $pickupTime.attr('max', end);
        if ($pickupTime.val()) {
            if (!timeWithinRange($pickupTime.val(), loc.StartTime, loc.EndTime)) {
                $pickupTime.val('');
            }
        }
    }

    function resetTimeConstraintsForDropoff(loc) {
        if (!loc || !loc.StartTime || !loc.EndTime) {
            $dropoffTime.attr('min', null).attr('max', null).val('');
            return;
        }
        var start = loc.StartTime.substring(0,5);
        var end = loc.EndTime.substring(0,5);
        $dropoffTime.attr('min', start);
        $dropoffTime.attr('max', end);
        if ($dropoffTime.val()) {
            if (!timeWithinRange($dropoffTime.val(), loc.StartTime, loc.EndTime)) {
                $dropoffTime.val('');
            }
        }
    }

    function onPickupLocationChange() {
        var val = $pickupSelect.val();
        var loc = locations.find(l => l.LocationId == val);
        if (loc) {
            $pickupDetails.html(formatLocationDetailsHtml(loc)).show();
            var today = new Date();
            var next = getNextAvailableDate(loc, today) || today;
            var minStr = next.toISOString().slice(0,10);
            $pickupDate.attr('min', minStr);

            var cur = $pickupDate.val();
            if (!cur || cur < minStr) {
                $pickupDate.val(minStr);
            }

            resetTimeConstraintsForPickup(loc);

            updateDropoffMinFromPickup();
        } else {
            $pickupDetails.hide().html('');
            $pickupDate.attr('min', new Date().toISOString().slice(0,10));
            resetTimeConstraintsForPickup(null);
        }
        clearErrors();
    }

    function onDropoffLocationChange() {
        var val = $dropoffSelect.val();
        var loc = locations.find(l => l.LocationId == val);
        if (loc) {
            $dropoffDetails.html(formatLocationDetailsHtml(loc)).show();

            updateDropoffMinFromPickup();

            resetTimeConstraintsForDropoff(loc);
        } else {
            $dropoffDetails.hide().html('');
            $dropoffDate.attr('min', new Date().toISOString().slice(0,10));
            resetTimeConstraintsForDropoff(null);
        }
        clearErrors();
    }

    function updateDropoffMinFromPickup() {
        var dropLocVal = $dropoffSelect.val();
        var dropLoc = locations.find(l => l.LocationId == dropLocVal);

        var pickVal = $pickupDate.val();
        var startFrom = pickVal ? new Date(pickVal + 'T00:00:00') : new Date();
        if (dropLoc) {
            var next = getNextAvailableDate(dropLoc, startFrom) || startFrom;
            var minStr = next.toISOString().slice(0,10);
            $dropoffDate.attr('min', minStr);

            var curDrop = $dropoffDate.val();
            if (!curDrop || curDrop < minStr) {
                $dropoffDate.val(minStr);
            }
        } else {
            var fallbackMin = startFrom.toISOString().slice(0,10);
            $dropoffDate.attr('min', fallbackMin);
            var curDrop = $dropoffDate.val();
            if (!curDrop || curDrop < fallbackMin) {
                $dropoffDate.val(fallbackMin);
            }
        }
    }

    function clearErrors() {
        $pickupDateError.hide().text('');
        $dropoffDateError.hide().text('');
        $pickupTimeError.hide().text('');
        $dropoffTimeError.hide().text('');
    }

    $pickupSelect.on('change', onPickupLocationChange);
    $dropoffSelect.on('change', onDropoffLocationChange);

    $pickupDate.on('change', function () {
        clearErrors();
        var val = $(this).val();
        if (!val) return;
        var locVal = $pickupSelect.val();
        var loc = locations.find(l => l.LocationId == locVal);
        if (loc) {
            var d = new Date(val + 'T00:00:00');
            if (!isLocationAvailableOnDate(loc, d)) {
                $pickupDateError.show().text('Seçtiğiniz lokasyon bu tarihte kapalı. Lütfen uygun bir tarih seçin.');
                $(this).val('');
                return;
            }
        }
        updateDropoffMinFromPickup();
    });

    $dropoffDate.on('change', function () {
        clearErrors();
        var val = $(this).val();
        if (!val) return;
        var locVal = $dropoffSelect.val();
        var loc = locations.find(l => l.LocationId == locVal);
        if (loc) {
            var d = new Date(val + 'T00:00:00');
            if (!isLocationAvailableOnDate(loc, d)) {
                $dropoffDateError.show().text('Seçtiğiniz teslim lokasyonu bu tarihte kapalı. Lütfen uygun bir tarih seçin.');
                $(this).val('');
                return;
            }
        }
        var pick = $pickupDate.val();
        if (pick && val < pick) {
            $dropoffDateError.show().text('Teslim tarihi, alış tarihinden önce olamaz.');
            $(this).val('');
            return;
        }
    });

    $pickupTime.on('change', function () {
        clearErrors();
        var t = $(this).val();
        var locVal = $pickupSelect.val();
        var loc = locations.find(l => l.LocationId == locVal);
        if (loc && !timeWithinRange(t, loc.StartTime, loc.EndTime)) {
            $pickupTimeError.show().text('Seçtiğiniz saat, alış lokasyonunun çalışma saatleri dışında. Lütfen uygun bir saat seçin.');
            $(this).val('');
            return;
        }
    });

    $dropoffTime.on('change', function () {
        clearErrors();
        var t = $(this).val();
        var locVal = $dropoffSelect.val();
        var loc = locations.find(l => l.LocationId == locVal);
        if (loc && !timeWithinRange(t, loc.StartTime, loc.EndTime)) {
            $dropoffTimeError.show().text('Seçtiğiniz saat, teslim lokasyonunun çalışma saatleri dışında. Lütfen uygun bir saat seçin.');
            $(this).val('');
            return;
        }
    });

    // 2. adım elemanları
    var $step1 = $('#step1');
    var $step2 = $('#step2');
    var $carsList = $('#carsList');
    var $nextStep2 = $('#nextStep2');
    var selectedCarId = null;

    // 1. adım ileri butonu (önceki submit kaldırıldı, yeni davranış ekleniyor)
    $('#nextStep').off('click').on('click', function() {
        clearErrors();

        var pickLocId = $pickupSelect.val();
        var dropLocId = $dropoffSelect.val();
        var pickDate = $pickupDate.val();
        var dropDate = $dropoffDate.val();
        var pickTime = $pickupTime.val();
        var dropTime = $dropoffTime.val();

        if (!pickLocId) { alert('Lütfen alış lokasyonu seçin.'); return; }
        if (!dropLocId) { alert('Lütfen teslim lokasyonu seçin.'); return; }
        if (!pickDate) { $pickupDateError.show().text('Lütfen alış tarihini seçin.'); return; }
        if (!dropDate) { $dropoffDateError.show().text('Lütfen teslim tarihini seçin.'); return; }
        if (!pickTime) { $pickupTimeError.show().text('Lütfen alış saatini seçin.'); return; }
        if (!dropTime) { $dropoffTimeError.show().text('Lütfen teslim saatini seçin.'); return; }

        var pickLoc = locations.find(l => l.LocationId == pickLocId);
        var dropLoc = locations.find(l => l.LocationId == dropLocId);

        var pd = new Date(pickDate + 'T00:00:00');
        if (!isLocationAvailableOnDate(pickLoc, pd)) {
            $pickupDateError.show().text('Alış lokasyonu seçtiğiniz tarihte kapalı. Lütfen başka tarih seçin.');
            return;
        }

        var dd = new Date(dropDate + 'T00:00:00');
        if (!isLocationAvailableOnDate(dropLoc, dd)) {
            $dropoffDateError.show().text('Teslim lokasyonu seçtiğiniz tarihte kapalı. Lütfen başka tarih seçin.');
            return;
        }

        if (!timeWithinRange(pickTime, pickLoc.StartTime, pickLoc.EndTime)) {
            $pickupTimeError.show().text('Alış saati lokasyonun çalışma saatleri arasında olmalı.');
            return;
        }
        if (!timeWithinRange(dropTime, dropLoc.StartTime, dropLoc.EndTime)) {
            $dropoffTimeError.show().text('Teslim saati lokasyonun çalışma saatleri arasında olmalı.');
            return;
        }

        if (dropDate < pickDate) {
            $dropoffDateError.show().text('Teslim tarihi, alış tarihinden önce olamaz.');
            return;
        }

        // 1. adımı gizle, 2. adımı göster
        $step1.hide();
        $step2.show();

        // Araçları getir
        fetchAvailableCars(pickLocId);
    });

    function fetchAvailableCars(locationId) {
        $carsList.html('<p>Yükleniyor...</p>');
        $nextStep2.prop('disabled', true);
        selectedCarId = null;

        $.ajax({
            url: `/Reservation/GetAvailableCars?locationId=${locationId}`,
            method: 'GET',
            success: function(data) {
                if (data && data.length) {
                    $carsList.empty();
                    data.forEach(function(car) {
                        var cardHtml = `
                        <div class="col-md-4 mb-3">
                          <div class="card car-card" data-carid="${car.carId}" style="cursor:pointer;">
                            <img src="${car.coverImageUrl}" class="card-img-top" alt="${car.model}">
                            <div class="card-body">
                              <h5 class="card-title">${car.brand.name} - ${car.model}</h5>
                              <p class="card-text">
                                Yıl: ${car.year}<br/>
                                Koltuk: ${car.seat}<br/>
                                Vites: ${car.transmission === 1 ? 'Manuel' : 'Otomatik'}
                              </p>
                            </div>
                          </div>
                        </div>`;
                        $carsList.append(cardHtml);
                    });

                    // Araç kartlarına tıklama eventi
                    $('.car-card').on('click', function() {
                        $('.car-card').removeClass('border-primary');
                        $(this).addClass('border-primary');
                        selectedCarId = $(this).data('carid');
                        $nextStep2.prop('disabled', false);
                    });
                } else {
                    $carsList.html('<p>Seçilen lokasyonda uygun araç bulunamadı.</p>');
                }
            },
            error: function() {
                $carsList.html('<p>Araçlar yüklenirken hata oluştu.</p>');
            }
        });
    }

    // 2. adım ileri butonu
    $nextStep2.on('click', function() {
        if (!selectedCarId) {
            alert('Lütfen bir araç seçin.');
            return;
        }
        // Seçilen araç ID'sini form'a gizli input olarak ekle
        if ($('#selectedCarId').length === 0) {
            $('<input>').attr({
                type: 'hidden',
                id: 'selectedCarId',
                name: 'SelectedCarId',
                value: selectedCarId
            }).appendTo($('#reservationForm'));
        } else {
            $('#selectedCarId').val(selectedCarId);
        }
        // Formu submit et
        $('#reservationForm').submit();
    });

    // Geri butonu ile 1. adıma dön
    $('#backToStep1').on('click', function() {
        $step2.hide();
        $step1.show();
    });

    // Sayfa açılırken min tarih = bugün
    $(function () {
        var today = new Date().toISOString().slice(0,10);
        $pickupDate.attr('min', today);
        $dropoffDate.attr('min', today);
    });

</script>

<style>
    /* Seçili araç kartına border koy */
    .car-card.border-primary {
        border: 3px solid #007bff;
    }
</style>
